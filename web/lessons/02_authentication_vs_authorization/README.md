# レッスン02: 認証と認可の違い

## このレッスンで考えること

- 「ログインできた」と「操作が許可されている」は同じか？
- OAuth は認証か、認可か？
- 「権限がない」エラーと「ログインしていない」エラーは何が違う？

---

## 1. 認証（Authentication）とは

**「あなたは誰ですか？」** を確認するプロセス。

### 具体例

- ユーザー名とパスワードでログインする
- 指紋や顔認証でスマホのロックを解除する
- 社員証をかざしてオフィスに入る

### 認証の成果物

認証が成功すると、**「この人は○○さんである」** という事実が確定する。

システム的には：
- セッションが作られる
- トークンが発行される
- 「誰であるか」を証明する何かが得られる

---

## 2. 認可（Authorization）とは

**「あなたは何ができますか？」** を確認するプロセス。

### 具体例

- 一般社員は経理システムを見られないが、経理部員は見られる
- 無料ユーザーは月5回までダウンロード、有料ユーザーは無制限
- 自分の投稿は編集できるが、他人の投稿は編集できない

### 認可の前提

認可は**認証の後に**行われる。

「誰であるか」がわからなければ、「何ができるか」を判断できない。

---

## 3. 両者の関係

```
┌─────────────────────────────────────────────────┐
│ リクエスト                                        │
└─────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────┐
│ 認証（Authentication）                           │
│ 「このリクエストを送ってきたのは誰か？」              │
│                                                 │
│ - 未ログイン → 401 Unauthorized                  │
│ - ログイン済み → ユーザー情報を特定して次へ          │
└─────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────┐
│ 認可（Authorization）                            │
│ 「このユーザーはこの操作をしていいか？」             │
│                                                 │
│ - 権限なし → 403 Forbidden                       │
│ - 権限あり → 処理を実行                           │
└─────────────────────────────────────────────────┘
```

---

## 4. HTTPステータスコードとの対応

| コード | 意味 | どの段階の問題か |
|--------|------|------------------|
| 401 Unauthorized | 認証されていない | 認証の失敗 |
| 403 Forbidden | アクセス権がない | 認可の失敗 |

### 紛らわしい命名

`401 Unauthorized` は名前が紛らわしい。

- "Unauthorized" は「認可されていない」と読める
- しかし実際の意味は「認証されていない」
- 本来は "Unauthenticated" という名前が適切だった

これは HTTP 仕様の歴史的な命名ミス。

---

## 5. 実務でよくある混乱

### ケース1: 「ログインしてるのに見れない」

ユーザーからの問い合わせ：
> ログインしてるのに管理画面が見れません

これは認証の問題？認可の問題？

→ **認可の問題**。ログイン（認証）は成功しているが、管理画面を見る権限（認可）がない。

### ケース2: APIトークンの「スコープ」

GitHub の Personal Access Token を作るとき、`repo` や `read:user` などを選ぶ。

これは何を設定している？

→ **認可の範囲**。トークン自体が認証の手段で、スコープが認可の範囲を決める。

### ケース3: OAuth は認証？認可？

「Googleでログイン」は OAuth を使っている。
これは認証？認可？

→ **OAuth 2.0 自体は認可の仕組み**。

ただし「Googleでログイン」は、OAuth に **OpenID Connect（OIDC）** を組み合わせて認証を実現している。

これは次のレッスンで詳しくやる。

---

## 6. 認証と認可を分けて考える理由

### 責務の分離

認証と認可は別の責務：

- 認証: ユーザー管理、パスワード管理、多要素認証など
- 認可: 権限管理、ロール設計、ポリシー管理など

混ぜると複雑になる。

### 変更の影響範囲

- 「パスワードの要件を厳しくする」→ 認証だけ変更
- 「新しいロールを追加する」→ 認可だけ変更

分離されていれば、影響範囲が明確。

### 外部委託の可能性

- 認証: Auth0、Firebase Auth、Cognito などに委託可能
- 認可: アプリケーションのビジネスロジックに依存するため、委託しにくい

---

## 確認問題

### Q1. 分類

以下のそれぞれは「認証」「認可」のどちらに関係するか？

1. パスワードリセット機能
2. 「管理者のみ削除可能」という制限
3. APIキーの発行
4. 「自分の投稿のみ編集可能」という制限
5. 二要素認証（2FA）の設定

### Q2. エラーの判断

あるAPIを叩いたら `403 Forbidden` が返ってきた。
「ログインし直せば解決する」は正しいか？ 理由も述べよ。

### Q3. OAuth の本質

「OAuth 2.0 は認可の仕組みであり、認証の仕組みではない」

この説明を、具体例を使って自分の言葉で説明せよ。

（ヒント: OAuth で何を「許可」しているのかを考える）

### Q4. レッスン01との関連

CSRFトークンは「認証」「認可」のどちらに近い仕組みか？
それとも、どちらでもないか？ 理由も述べよ。

---

回答を送ってくれたら、一緒に議論しよう。
